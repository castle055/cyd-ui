.TH "src/graphics/x11/x11_impl.cpp" 3 "CYD-UI" \" -*- nroff -*-
.ad l
.nh
.SH NAME
src/graphics/x11/x11_impl.cpp
.SH SYNOPSIS
.br
.PP
\fC#include 'cydstd/cydstd\&.h'\fP
.br
\fC#include 'cydstd/logging\&.hpp'\fP
.br
\fC#include 'images\&.h'\fP
.br
\fC#include 'events/events\&.hpp'\fP
.br
\fC#include <X11/Xft/Xft\&.h>\fP
.br
\fC#include <X11/Xlib\&.h>\fP
.br
\fC#include <X11/Xutil\&.h>\fP
.br
\fC#include <png\&.h>\fP
.br
\fC#include 'state/state\&.hpp'\fP
.br
\fC#include 'render/render\&.hpp'\fP
.br

.SS "Functions"

.in +1c
.ti -1c
.RI "char * \fBlog_error_code\fP (int err)"
.br
.ti -1c
.RI "static Bool \fBevpredicate\fP ()"
.br
.ti -1c
.RI "static int \fBgeom_mask_to_gravity\fP (int mask)"
.br
.ti -1c
.RI "static \fBstr\fP \fBto_pattern\fP (\fBfont::Font\fP *font)"
.br
.ti -1c
.RI "static \fBwindow_font\fP \fBload_font\fP (\fBcydui::graphics::window_t\fP *win, \fBfont::Font\fP *font)"
.br
.ti -1c
.RI "static void \fBunload_font\fP (\fBcydui::graphics::window_t\fP *win, \fBfont::Font\fP *font)"
.br
.ti -1c
.RI "static \fBwindow_image\fP \fBload_image\fP (\fBcydui::graphics::window_t\fP *win, \fBcydui::graphics::images::image_t\fP *img)"
.br
.ti -1c
.RI "static void \fBunload_image\fP (\fBcydui::graphics::window_t\fP *win, \fBcydui::graphics::images::image_t\fP *img)"
.br
.ti -1c
.RI "std::pair< int, int > \fBget_text_size\fP (\fBfont::Font\fP *font, const \fBstr\fP &text)"
.br
.ti -1c
.RI "std::pair< int, int > \fBget_image_size\fP (\fBcydui::graphics::images::image_t\fP *img)"
.br
.in -1c
.SS "Variables"

.in +1c
.ti -1c
.RI "const \fBlogging::logger\fP \fBlog_task\fP = {\&.name = 'X11_IMPL', \&.on = true}"
.br
.ti -1c
.RI "static std::unordered_map< \fBstr\fP, XftFont * > \fBcached_fonts\fP"
.br
.in -1c
.SH "Function Documentation"
.PP 
.SS "static Bool evpredicate ()\fC [static]\fP"

.PP
Definition at line \fB26\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
26                           {
27   return True;
28 }
.fi

.SS "static int geom_mask_to_gravity (int mask)\fC [static]\fP"

.PP
Definition at line \fB30\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
30                                           {
31   switch (mask & (XNegative | YNegative)) {
32     case 0:
33       return NorthWestGravity;
34     case XNegative:
35       return NorthEastGravity;
36     case YNegative:
37       return SouthWestGravity;
38   }
39   
40   return SouthEastGravity;
41 }
.fi

.SS "std::pair< int, int > get_image_size (\fBcydui::graphics::images::image_t\fP * img)"

.PP
Definition at line \fB282\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
284   {
285   imgs::img_data data = imgs::read_jpg(img\->path);
286   return {data\&.width, data\&.height};
287 }
.fi

.SS "std::pair< int, int > get_text_size (\fBfont::Font\fP * font, const \fBstr\fP & text)"

.PP
Definition at line \fB257\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
259   {
260   str font_spec = to_pattern(font);
261   XftFont* xfont;
262   if (cached_fonts\&.contains(font_spec)) {
263     xfont = cached_fonts[font_spec];
264   } else {
265     if (!(xfont = XftFontOpenName(
266       state::get_dpy(), state::get_screen(), font_spec\&.c_str()))) {
267       log_task\&.error("Cannot load font from name %s", font_spec\&.c_str());
268       return {};
269     }
270     cached_fonts[font_spec] = xfont;
271   }
272   XGlyphInfo x_glyph_info;
273   XftTextExtentsUtf8(state::get_dpy(),
274     xfont,
275     (XftChar8*) text\&.c_str(),
276     (int) text\&.size(),
277     &x_glyph_info);
278   //XftFontClose(state::get_dpy(), xfont);
279   return {x_glyph_info\&.xOff, x_glyph_info\&.y};
280 }
.fi

.SS "static \fBwindow_font\fP load_font (\fBcydui::graphics::window_t\fP * win, \fBfont::Font\fP * font)\fC [static]\fP"

.PP
Definition at line \fB185\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
187   {
188   str font_spec = to_pattern(font);
189   if (win\->loaded_fonts\&.contains(font_spec))
190     return win\->loaded_fonts[font_spec];
191   XftFont* xfont;
192   FcPattern* pattern;
193   
194   if (!(xfont = XftFontOpenName(
195     state::get_dpy(), state::get_screen(), font_spec\&.c_str()))) {
196     log_task\&.error("Cannot load font from name %s", font_spec\&.c_str());
197     return {};
198   }
199   if (!(pattern = FcNameParse((FcChar8*) (font_spec\&.c_str())))) {
200     log_task\&.error("Cannot parse font name to pattern: %s", font_spec\&.c_str());
201     return {};
202   }
203   
204   auto f = window_font {\&.xfont = xfont, \&.pattern = pattern};
205   win\->loaded_fonts[font_spec] = f;
206   return f;
207 }
.fi

.SS "static \fBwindow_image\fP load_image (\fBcydui::graphics::window_t\fP * win, \fBcydui::graphics::images::image_t\fP * img)\fC [static]\fP"

.PP
Definition at line \fB215\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
217   {
218   if (win\->loaded_images\&.contains(img\->path))
219     return win\->loaded_images[img\->path];
220   
221   XImage* image = nullptr;
222   
223   //if (img\->path\&.ends_with("\&.jpg")
224   //  || img\->path\&.ends_with("jpeg")) {
225   imgs::img_data data = imgs::read_jpg(img\->path);
226   
227   image = XCreateImage(state::get_dpy(),
228     CopyFromParent,
229     DisplayPlanes(state::get_dpy(), state::get_screen()),
230     ZPixmap,
231     0,
232     data\&.data,
233     data\&.width,
234     data\&.height,
235     8,
236     data\&.width * data\&.components);
237   //log_task\&.info("STATUS = %d", XInitImage(image));
238   //}
239   
240   //
241   //auto f = window_font {\&.xfont = xfont, \&.pattern = pattern};
242   //win\->loaded_fonts[font_spec] = f;
243   auto i = window_image {image};
244   win\->loaded_images[img\->path] = i;
245   return i;
246 }
.fi

.SS "char * log_error_code (int err)"

.PP
Definition at line \fB20\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
20                               {
21   static char buf[128];
22   XGetErrorText(state::get_dpy(), err, buf, 128);
23   return buf;
24 }
.fi

.SS "static \fBstr\fP to_pattern (\fBfont::Font\fP * font)\fC [static]\fP"

.PP
Definition at line \fB171\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
171                                       {
172   str str;
173   str\&.append(font\->name + ":");
174   str\&.append("size=" + std::to_string(font\->size) + ":");
175   str\&.append("antialias=");
176   str\&.append((font\->antialias ? "true" : "false"));
177   str\&.append(":");
178   str\&.append("autohint=");
179   str\&.append((font\->autohint ? "true" : "false"));
180   //str\&.append(":");
181   
182   return str;
183 }
.fi

.SS "static void unload_font (\fBcydui::graphics::window_t\fP * win, \fBfont::Font\fP * font)\fC [static]\fP"

.PP
Definition at line \fB209\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
211   {
212   // TODO \- Implement
213 }
.fi

.SS "static void unload_image (\fBcydui::graphics::window_t\fP * win, \fBcydui::graphics::images::image_t\fP * img)\fC [static]\fP"

.PP
Definition at line \fB248\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
251   {
252   // TODO \- Implement
253 }
.fi

.SH "Variable Documentation"
.PP 
.SS "std::unordered_map<\fBstr\fP, XftFont*> cached_fonts\fC [static]\fP"

.PP
Definition at line \fB255\fP of file \fBx11_impl\&.cpp\fP\&.
.SS "const \fBlogging::logger\fP log_task = {\&.name = 'X11_IMPL', \&.on = true}"

.PP
Definition at line \fB18\fP of file \fBx11_impl\&.cpp\fP\&..PP
.nf
18 {\&.name = "X11_IMPL", \&.on = true};
.fi

.SH "Author"
.PP 
Generated automatically by Doxygen for CYD-UI from the source code\&.
